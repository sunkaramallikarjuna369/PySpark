<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aggregations - PySpark Learning Hub</title>
    <link rel="stylesheet" href="../../assets/css/main.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Fira+Code&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
</head>
<body>
    <header class="header">
        <div class="container header-content">
            <a href="../../index.html" class="logo">
                <svg class="logo-icon" viewBox="0 0 40 40" fill="none">
                    <rect width="40" height="40" rx="8" fill="#e25a1c"/>
                    <path d="M12 20L20 12L28 20L20 28L12 20Z" fill="white"/>
                    <circle cx="20" cy="20" r="4" fill="#e25a1c"/>
                </svg>
                <span>Data Engineering Hub</span>
            </a>
            <nav class="nav">
                <a href="../../index.html#pyspark" class="nav-link active">PySpark</a>
                <a href="../../index.html#pandas" class="nav-link">Pandas</a>
                <a href="../../index.html#sql" class="nav-link">SQL</a>
                <a href="../../index.html#etl" class="nav-link">ETL</a>
                <a href="../../index.html#datawarehouse" class="nav-link">Data Warehouse</a>
                <button class="theme-toggle">üåô</button>
            </nav>
        </div>
    </header>

    <main class="container">
        <nav class="breadcrumb">
            <span class="breadcrumb-item"><a href="../../index.html">Home</a></span>
            <span class="breadcrumb-separator">/</span>
            <span class="breadcrumb-item"><a href="../../index.html#pyspark">PySpark</a></span>
            <span class="breadcrumb-separator">/</span>
            <span class="breadcrumb-item">Aggregations</span>
        </nav>

        <section class="section">
            <h1>Aggregations</h1>
            <p>Aggregations combine multiple rows into summary statistics. Spark provides powerful aggregation capabilities through groupBy operations, pivot tables, and built-in aggregate functions.</p>

            <div class="info-box info">
                <strong>Key Concept:</strong> Aggregations are wide transformations that require shuffling data across partitions. Understanding how to optimize aggregations is crucial for performance.
            </div>

            <h2>3D Visualization: Aggregation Process</h2>
            <div id="visualization" class="visualization-container"></div>
            <div class="visualization-controls">
                <button class="viz-btn" onclick="showGroupBy()">GroupBy</button>
                <button class="viz-btn" onclick="showPivot()">Pivot</button>
                <button class="viz-btn" onclick="showRollup()">Rollup</button>
            </div>

            <h2>Code Examples</h2>

            <div class="tabs">
                <button class="tab active" data-tab="basic">Basic Aggregations</button>
                <button class="tab" data-tab="groupby">GroupBy Operations</button>
                <button class="tab" data-tab="pivot">Pivot & Cube</button>
            </div>

            <div class="tab-contents">
                <div id="basic" class="tab-content active">
                    <div class="code-container">
                        <div class="code-header">
                            <span class="code-language">Python</span>
                            <button class="copy-btn">Copy</button>
                        </div>
                        <div class="code-block">
<pre>from pyspark.sql import SparkSession
from pyspark.sql.functions import (
    sum, avg, min, max, count, countDistinct,
    first, last, collect_list, collect_set,
    stddev, variance, skewness, kurtosis,
    approx_count_distinct, percentile_approx
)

spark = SparkSession.builder.appName("Aggregations").getOrCreate()

data = [
    ("Engineering", "Alice", 75000, 5),
    ("Engineering", "Bob", 80000, 3),
    ("Engineering", "Charlie", 75000, 7),
    ("Marketing", "Diana", 60000, 4),
    ("Marketing", "Eve", 65000, 6),
    ("Sales", "Frank", 55000, 2),
    ("Sales", "Grace", 58000, 8)
]
df = spark.createDataFrame(data, ["department", "name", "salary", "years"])

# Basic aggregate functions
print("Basic Aggregations:")
df.select(
    count("*").alias("total_rows"),
    countDistinct("department").alias("unique_depts"),
    sum("salary").alias("total_salary"),
    avg("salary").alias("avg_salary"),
    min("salary").alias("min_salary"),
    max("salary").alias("max_salary")
).show()

# Statistical functions
print("Statistical Aggregations:")
df.select(
    stddev("salary").alias("stddev"),
    variance("salary").alias("variance"),
    skewness("salary").alias("skewness"),
    kurtosis("salary").alias("kurtosis")
).show()

# Approximate aggregations (for large datasets)
print("Approximate Aggregations:")
df.select(
    approx_count_distinct("department").alias("approx_distinct"),
    percentile_approx("salary", 0.5).alias("median_salary")
).show()

# Collection functions
print("Collection Aggregations:")
df.select(
    collect_list("name").alias("all_names"),
    collect_set("department").alias("unique_depts")
).show(truncate=False)

spark.stop()</pre>
                        </div>
                    </div>
                </div>

                <div id="groupby" class="tab-content">
                    <div class="code-container">
                        <div class="code-header">
                            <span class="code-language">Python</span>
                            <button class="copy-btn">Copy</button>
                        </div>
                        <div class="code-block">
<pre>from pyspark.sql import SparkSession
from pyspark.sql.functions import sum, avg, count, max, min, col

spark = SparkSession.builder.appName("GroupBy").getOrCreate()

data = [
    ("Engineering", "Alice", 75000, "2023"),
    ("Engineering", "Bob", 80000, "2023"),
    ("Engineering", "Charlie", 75000, "2022"),
    ("Marketing", "Diana", 60000, "2023"),
    ("Marketing", "Eve", 65000, "2022"),
    ("Sales", "Frank", 55000, "2023"),
    ("Sales", "Grace", 58000, "2022")
]
df = spark.createDataFrame(data, ["department", "name", "salary", "year"])

# Simple groupBy
print("GroupBy Department:")
df.groupBy("department").agg(
    count("*").alias("employee_count"),
    sum("salary").alias("total_salary"),
    avg("salary").alias("avg_salary")
).show()

# Multiple groupBy columns
print("GroupBy Department and Year:")
df.groupBy("department", "year").agg(
    count("*").alias("count"),
    avg("salary").alias("avg_salary")
).orderBy("department", "year").show()

# Using agg with expressions
print("Multiple Aggregations:")
df.groupBy("department").agg(
    count("*").alias("count"),
    sum("salary").alias("total"),
    avg("salary").alias("average"),
    min("salary").alias("minimum"),
    max("salary").alias("maximum")
).show()

# Filter after groupBy (HAVING equivalent)
print("Filter After GroupBy (HAVING):")
df.groupBy("department").agg(
    count("*").alias("count"),
    avg("salary").alias("avg_salary")
).filter(col("count") > 1).show()

# OrderBy after groupBy
print("Ordered Results:")
df.groupBy("department").agg(
    avg("salary").alias("avg_salary")
).orderBy(col("avg_salary").desc()).show()

spark.stop()</pre>
                        </div>
                    </div>
                </div>

                <div id="pivot" class="tab-content">
                    <div class="code-container">
                        <div class="code-header">
                            <span class="code-language">Python</span>
                            <button class="copy-btn">Copy</button>
                        </div>
                        <div class="code-block">
<pre>from pyspark.sql import SparkSession
from pyspark.sql.functions import sum, avg, count

spark = SparkSession.builder.appName("Pivot and Cube").getOrCreate()

data = [
    ("Engineering", "Q1", 100000),
    ("Engineering", "Q2", 120000),
    ("Engineering", "Q3", 110000),
    ("Marketing", "Q1", 80000),
    ("Marketing", "Q2", 85000),
    ("Marketing", "Q3", 90000),
    ("Sales", "Q1", 70000),
    ("Sales", "Q2", 75000),
    ("Sales", "Q3", 80000)
]
df = spark.createDataFrame(data, ["department", "quarter", "revenue"])

# Pivot table
print("Pivot Table:")
df.groupBy("department").pivot("quarter").sum("revenue").show()

# Pivot with specific values (more efficient)
print("Pivot with Specific Values:")
df.groupBy("department").pivot("quarter", ["Q1", "Q2", "Q3"]).sum("revenue").show()

# Unpivot (stack)
pivoted = df.groupBy("department").pivot("quarter").sum("revenue")
print("Unpivot (Stack):")
pivoted.selectExpr(
    "department",
    "stack(3, 'Q1', Q1, 'Q2', Q2, 'Q3', Q3) as (quarter, revenue)"
).show()

# Rollup - Hierarchical aggregation
print("Rollup:")
df.rollup("department", "quarter").sum("revenue").orderBy("department", "quarter").show()

# Cube - All combinations
print("Cube:")
df.cube("department", "quarter").sum("revenue").orderBy("department", "quarter").show()

# Grouping sets equivalent
print("Grouping Sets (using union):")
dept_total = df.groupBy("department").agg(sum("revenue").alias("total"))
quarter_total = df.groupBy("quarter").agg(sum("revenue").alias("total"))
grand_total = df.agg(sum("revenue").alias("total"))

dept_total.show()
quarter_total.show()
grand_total.show()

spark.stop()</pre>
                        </div>
                    </div>
                </div>
            </div>

            <div style="display: flex; justify-content: space-between; margin-top: 3rem; padding-top: 2rem; border-top: 1px solid var(--border-color);">
                <a href="../06_window_functions/index.html" style="color: var(--text-muted);">‚Üê Previous: Window Functions</a>
                <a href="../08_udfs/index.html" style="color: var(--accent-primary);">Next: UDFs ‚Üí</a>
            </div>
        </section>
    </main>

    <footer class="footer">
        <div class="container footer-content">
            <p style="margin: 0; color: var(--text-muted);">PySpark & Data Engineering Learning Hub</p>
        </div>
    </footer>

    <script src="../../assets/js/main.js"></script>
    <script src="../../assets/js/visualization.js"></script>
    <script>
        let viz;

        document.addEventListener('DOMContentLoaded', function() {
            viz = new DataVisualization('visualization', {
                backgroundColor: document.documentElement.getAttribute('data-theme') === 'dark' ? 0x1a1a2e : 0xf8f9fa,
                cameraPosition: { x: 5, y: 3, z: 5 }
            });
            showGroupBy();
        });

        function showGroupBy() {
            viz.clear();
            
            // Input rows
            const colors = [0xe25a1c, 0xe25a1c, 0x4dabf7, 0x4dabf7, 0x198754];
            for (let i = 0; i < 5; i++) {
                viz.createDataNode({
                    type: 'cube', size: 0.35, color: colors[i],
                    position: { x: -3, y: 1.5 - i * 0.7, z: 0 }
                });
            }
            viz.createLabel('Input Rows', { x: -3, y: 2.5, z: 0 });

            // Grouped results
            viz.createDataNode({ type: 'cube', size: 0.6, color: 0xe25a1c, position: { x: 2, y: 1, z: 0 } });
            viz.createDataNode({ type: 'cube', size: 0.6, color: 0x4dabf7, position: { x: 2, y: 0, z: 0 } });
            viz.createDataNode({ type: 'cube', size: 0.6, color: 0x198754, position: { x: 2, y: -1, z: 0 } });
            viz.createLabel('Grouped', { x: 2, y: 2.5, z: 0 });

            viz.createArrow({ x: -2, y: 0.5, z: 0 }, { x: 1, y: 0.5, z: 0 }, { color: 0x888888 });
            viz.createLabel('GroupBy - Aggregate by key', { x: 0, y: -2, z: 0 });
            viz.createGrid(10, 10);
        }

        function showPivot() {
            viz.clear();
            
            // Source data
            for (let i = 0; i < 4; i++) {
                viz.createDataNode({
                    type: 'cube', size: 0.4, color: 0xe25a1c,
                    position: { x: -3, y: 1 - i * 0.7, z: 0 }
                });
            }
            viz.createLabel('Long Format', { x: -3, y: 2, z: 0 });

            // Pivoted result (wide format)
            for (let r = 0; r < 2; r++) {
                for (let c = 0; c < 3; c++) {
                    viz.createDataNode({
                        type: 'cube', size: 0.4, color: 0x4dabf7,
                        position: { x: 1.5 + c * 0.6, y: 0.5 - r * 0.7, z: 0 }
                    });
                }
            }
            viz.createLabel('Wide Format', { x: 2.5, y: 2, z: 0 });

            viz.createArrow({ x: -2, y: 0.5, z: 0 }, { x: 1, y: 0.5, z: 0 }, { color: 0x888888 });
            viz.createLabel('Pivot - Long to Wide format', { x: 0, y: -2, z: 0 });
            viz.createGrid(10, 10);
        }

        function showRollup() {
            viz.clear();
            
            // Hierarchy levels
            viz.createDataNode({ type: 'sphere', size: 0.8, color: 0xe25a1c, position: { x: 0, y: 2, z: 0 } });
            viz.createLabel('Grand Total', { x: 0, y: 3, z: 0 });

            viz.createDataNode({ type: 'cube', size: 0.5, color: 0x4dabf7, position: { x: -1.5, y: 0.5, z: 0 } });
            viz.createDataNode({ type: 'cube', size: 0.5, color: 0x4dabf7, position: { x: 1.5, y: 0.5, z: 0 } });
            viz.createLabel('Dept Totals', { x: 0, y: 1.3, z: 0 });

            for (let i = 0; i < 4; i++) {
                viz.createDataNode({
                    type: 'cube', size: 0.35, color: 0x198754,
                    position: { x: -2 + i * 1.3, y: -1, z: 0 }
                });
            }
            viz.createLabel('Detail Rows', { x: 0, y: -0.3, z: 0 });

            viz.createArrow({ x: 0, y: 1.5, z: 0 }, { x: -1.5, y: 0.8, z: 0 }, { color: 0x888888 });
            viz.createArrow({ x: 0, y: 1.5, z: 0 }, { x: 1.5, y: 0.8, z: 0 }, { color: 0x888888 });
            viz.createLabel('Rollup - Hierarchical aggregation', { x: 0, y: -2.5, z: 0 });
            viz.createGrid(10, 10);
        }
    </script>
</body>
</html>
