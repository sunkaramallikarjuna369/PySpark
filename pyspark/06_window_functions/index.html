<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Window Functions - PySpark Learning Hub</title>
    <link rel="stylesheet" href="../../assets/css/main.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Fira+Code&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
</head>
<body>
    <header class="header">
        <div class="container header-content">
            <a href="../../index.html" class="logo">
                <svg class="logo-icon" viewBox="0 0 40 40" fill="none">
                    <rect width="40" height="40" rx="8" fill="#e25a1c"/>
                    <path d="M12 20L20 12L28 20L20 28L12 20Z" fill="white"/>
                    <circle cx="20" cy="20" r="4" fill="#e25a1c"/>
                </svg>
                <span>Data Engineering Hub</span>
            </a>
            <nav class="nav">
                <a href="../../index.html#pyspark" class="nav-link active">PySpark</a>
                <a href="../../index.html#pandas" class="nav-link">Pandas</a>
                <a href="../../index.html#sql" class="nav-link">SQL</a>
                <a href="../../index.html#etl" class="nav-link">ETL</a>
                <a href="../../index.html#datawarehouse" class="nav-link">Data Warehouse</a>
                <button class="theme-toggle">üåô</button>
            </nav>
        </div>
    </header>

    <main class="container">
        <nav class="breadcrumb">
            <span class="breadcrumb-item"><a href="../../index.html">Home</a></span>
            <span class="breadcrumb-separator">/</span>
            <span class="breadcrumb-item"><a href="../../index.html#pyspark">PySpark</a></span>
            <span class="breadcrumb-separator">/</span>
            <span class="breadcrumb-item">Window Functions</span>
        </nav>

        <section class="section">
            <h1>Window Functions</h1>
            <p>Window functions perform calculations across a set of rows that are related to the current row. Unlike regular aggregations, window functions don't collapse rows - they add computed values while preserving the original row structure.</p>

            <div class="info-box info">
                <strong>Key Concept:</strong> Window functions operate on a "window" of rows defined by PARTITION BY (grouping) and ORDER BY (sorting) clauses, with optional frame specifications.
            </div>

            <h2>3D Visualization: Window Frame</h2>
            <div id="visualization" class="visualization-container"></div>
            <div class="visualization-controls">
                <button class="viz-btn" onclick="showRowNumber()">ROW_NUMBER</button>
                <button class="viz-btn" onclick="showRank()">RANK</button>
                <button class="viz-btn" onclick="showRunningSum()">Running Sum</button>
                <button class="viz-btn" onclick="showLeadLag()">LEAD/LAG</button>
            </div>

            <h2>Types of Window Functions</h2>
            <ul style="color: var(--text-secondary); margin-left: 1.5rem;">
                <li><strong>Ranking:</strong> row_number(), rank(), dense_rank(), ntile()</li>
                <li><strong>Analytic:</strong> lead(), lag(), first_value(), last_value()</li>
                <li><strong>Aggregate:</strong> sum(), avg(), min(), max(), count() over window</li>
            </ul>

            <h2>Code Examples</h2>

            <div class="tabs">
                <button class="tab active" data-tab="ranking">Ranking Functions</button>
                <button class="tab" data-tab="analytic">Analytic Functions</button>
                <button class="tab" data-tab="aggregate">Aggregate Windows</button>
            </div>

            <div class="tab-contents">
                <div id="ranking" class="tab-content active">
                    <div class="code-container">
                        <div class="code-header">
                            <span class="code-language">Python</span>
                            <button class="copy-btn">Copy</button>
                        </div>
                        <div class="code-block">
<pre>from pyspark.sql import SparkSession
from pyspark.sql.window import Window
from pyspark.sql.functions import row_number, rank, dense_rank, ntile, col

spark = SparkSession.builder.appName("Window Functions").getOrCreate()

# Sample data
data = [
    ("Engineering", "Alice", 75000),
    ("Engineering", "Bob", 80000),
    ("Engineering", "Charlie", 75000),
    ("Marketing", "Diana", 60000),
    ("Marketing", "Eve", 65000),
    ("Sales", "Frank", 55000),
    ("Sales", "Grace", 58000),
    ("Sales", "Henry", 55000)
]
df = spark.createDataFrame(data, ["department", "name", "salary"])

# Define window specification
window_spec = Window.partitionBy("department").orderBy(col("salary").desc())

# ROW_NUMBER - Unique sequential number within partition
df.withColumn("row_num", row_number().over(window_spec)).show()
# Output: Each row gets unique number 1, 2, 3... within department

# RANK - Same rank for ties, gaps after ties
df.withColumn("rank", rank().over(window_spec)).show()
# Output: Ties get same rank, next rank skips (1, 1, 3)

# DENSE_RANK - Same rank for ties, no gaps
df.withColumn("dense_rank", dense_rank().over(window_spec)).show()
# Output: Ties get same rank, no gaps (1, 1, 2)

# NTILE - Divide into n buckets
df.withColumn("quartile", ntile(4).over(window_spec)).show()
# Output: Divides rows into 4 equal groups

# Combine multiple ranking functions
df.select(
    "department", "name", "salary",
    row_number().over(window_spec).alias("row_num"),
    rank().over(window_spec).alias("rank"),
    dense_rank().over(window_spec).alias("dense_rank")
).show()

# Get top N per group
window_rank = Window.partitionBy("department").orderBy(col("salary").desc())
df.withColumn("rank", row_number().over(window_rank)) \
  .filter(col("rank") <= 2) \
  .show()

spark.stop()</pre>
                        </div>
                    </div>
                </div>

                <div id="analytic" class="tab-content">
                    <div class="code-container">
                        <div class="code-header">
                            <span class="code-language">Python</span>
                            <button class="copy-btn">Copy</button>
                        </div>
                        <div class="code-block">
<pre>from pyspark.sql import SparkSession
from pyspark.sql.window import Window
from pyspark.sql.functions import lead, lag, first, last, col

spark = SparkSession.builder.appName("Analytic Functions").getOrCreate()

# Time series data
data = [
    ("2023-01-01", "Product A", 100),
    ("2023-01-02", "Product A", 120),
    ("2023-01-03", "Product A", 115),
    ("2023-01-04", "Product A", 130),
    ("2023-01-01", "Product B", 200),
    ("2023-01-02", "Product B", 180),
    ("2023-01-03", "Product B", 210)
]
df = spark.createDataFrame(data, ["date", "product", "sales"])

# Window ordered by date within product
window_spec = Window.partitionBy("product").orderBy("date")

# LEAD - Get value from next row
df.withColumn("next_day_sales", lead("sales", 1).over(window_spec)).show()
# Output: Shows sales from the next day

# LEAD with offset and default
df.withColumn("sales_2_days_later", lead("sales", 2, 0).over(window_spec)).show()

# LAG - Get value from previous row
df.withColumn("prev_day_sales", lag("sales", 1).over(window_spec)).show()
# Output: Shows sales from the previous day

# Calculate day-over-day change
df.withColumn("prev_sales", lag("sales", 1).over(window_spec)) \
  .withColumn("change", col("sales") - col("prev_sales")) \
  .show()

# FIRST_VALUE - First value in window
df.withColumn("first_sale", first("sales").over(window_spec)).show()

# LAST_VALUE - Last value in window (needs unbounded frame)
from pyspark.sql.window import Window
window_unbounded = Window.partitionBy("product").orderBy("date") \
    .rowsBetween(Window.unboundedPreceding, Window.unboundedFollowing)

df.withColumn("last_sale", last("sales").over(window_unbounded)).show()

# Percent change from first value
df.withColumn("first_sale", first("sales").over(window_spec)) \
  .withColumn("pct_change", 
              (col("sales") - col("first_sale")) / col("first_sale") * 100) \
  .show()

spark.stop()</pre>
                        </div>
                    </div>
                </div>

                <div id="aggregate" class="tab-content">
                    <div class="code-container">
                        <div class="code-header">
                            <span class="code-language">Python</span>
                            <button class="copy-btn">Copy</button>
                        </div>
                        <div class="code-block">
<pre>from pyspark.sql import SparkSession
from pyspark.sql.window import Window
from pyspark.sql.functions import sum, avg, min, max, count, col

spark = SparkSession.builder.appName("Aggregate Windows").getOrCreate()

data = [
    ("2023-01-01", "A", 100),
    ("2023-01-02", "A", 150),
    ("2023-01-03", "A", 120),
    ("2023-01-04", "A", 180),
    ("2023-01-05", "A", 200),
    ("2023-01-01", "B", 80),
    ("2023-01-02", "B", 90),
    ("2023-01-03", "B", 85)
]
df = spark.createDataFrame(data, ["date", "product", "sales"])

# Running sum (cumulative)
window_running = Window.partitionBy("product").orderBy("date") \
    .rowsBetween(Window.unboundedPreceding, Window.currentRow)

df.withColumn("running_total", sum("sales").over(window_running)).show()

# Running average
df.withColumn("running_avg", avg("sales").over(window_running)).show()

# Moving average (3-day window)
window_moving = Window.partitionBy("product").orderBy("date") \
    .rowsBetween(-2, Window.currentRow)

df.withColumn("moving_avg_3d", avg("sales").over(window_moving)).show()

# Running min/max
df.withColumn("running_min", min("sales").over(window_running)) \
  .withColumn("running_max", max("sales").over(window_running)) \
  .show()

# Percentage of total within partition
window_total = Window.partitionBy("product")
df.withColumn("total", sum("sales").over(window_total)) \
  .withColumn("pct_of_total", col("sales") / col("total") * 100) \
  .show()

# Range-based window (by value, not rows)
window_range = Window.partitionBy("product").orderBy("sales") \
    .rangeBetween(-50, 50)

df.withColumn("sales_in_range", count("*").over(window_range)).show()

# Complex example: Running total with percentage
window_cum = Window.partitionBy("product").orderBy("date") \
    .rowsBetween(Window.unboundedPreceding, Window.currentRow)
window_total = Window.partitionBy("product")

df.select(
    "date", "product", "sales",
    sum("sales").over(window_cum).alias("cumulative"),
    sum("sales").over(window_total).alias("total"),
    (sum("sales").over(window_cum) / sum("sales").over(window_total) * 100).alias("cum_pct")
).show()

spark.stop()</pre>
                        </div>
                    </div>
                </div>
            </div>

            <div class="info-box tip">
                <strong>Best Practice:</strong> Always specify the frame bounds explicitly when using aggregate functions over windows to avoid unexpected results. Use <code>rowsBetween()</code> for row-based frames and <code>rangeBetween()</code> for value-based frames.
            </div>

            <div style="display: flex; justify-content: space-between; margin-top: 3rem; padding-top: 2rem; border-top: 1px solid var(--border-color);">
                <a href="../05_joins/index.html" style="color: var(--text-muted);">‚Üê Previous: Joins</a>
                <a href="../07_aggregations/index.html" style="color: var(--accent-primary);">Next: Aggregations ‚Üí</a>
            </div>
        </section>
    </main>

    <footer class="footer">
        <div class="container footer-content">
            <p style="margin: 0; color: var(--text-muted);">PySpark & Data Engineering Learning Hub</p>
        </div>
    </footer>

    <script src="../../assets/js/main.js"></script>
    <script src="../../assets/js/visualization.js"></script>
    <script>
        let viz;

        document.addEventListener('DOMContentLoaded', function() {
            viz = new DataVisualization('visualization', {
                backgroundColor: document.documentElement.getAttribute('data-theme') === 'dark' ? 0x1a1a2e : 0xf8f9fa,
                cameraPosition: { x: 5, y: 3, z: 5 }
            });
            showRowNumber();
        });

        function showRowNumber() {
            viz.clear();
            
            // Data rows with row numbers
            const rows = [
                { y: 1.5, num: 1, color: 0xe25a1c },
                { y: 0.7, num: 2, color: 0x4dabf7 },
                { y: -0.1, num: 3, color: 0x198754 },
                { y: -0.9, num: 4, color: 0x8b5cf6 }
            ];

            rows.forEach(r => {
                viz.createDataNode({
                    type: 'cube', size: 0.5, color: r.color,
                    position: { x: -1, y: r.y, z: 0 }
                });
                viz.createLabel(r.num.toString(), { x: 1, y: r.y, z: 0 });
            });

            viz.createLabel('Data', { x: -1, y: 2.5, z: 0 });
            viz.createLabel('ROW_NUMBER', { x: 1, y: 2.5, z: 0 });
            viz.createLabel('ROW_NUMBER() - Unique sequential numbers', { x: 0, y: -2, z: 0 });
            viz.createGrid(10, 10);
        }

        function showRank() {
            viz.clear();
            
            // Data with ties
            const rows = [
                { y: 1.5, value: 100, rank: 1 },
                { y: 0.7, value: 100, rank: 1 },
                { y: -0.1, value: 90, rank: 3 },
                { y: -0.9, value: 80, rank: 4 }
            ];

            rows.forEach(r => {
                viz.createDataNode({
                    type: 'cube', size: 0.5, color: r.rank === 1 ? 0xe25a1c : 0x4dabf7,
                    position: { x: -1.5, y: r.y, z: 0 }
                });
                viz.createLabel(r.value.toString(), { x: 0, y: r.y, z: 0 });
                viz.createLabel(r.rank.toString(), { x: 1.5, y: r.y, z: 0 });
            });

            viz.createLabel('Data', { x: -1.5, y: 2.5, z: 0 });
            viz.createLabel('Value', { x: 0, y: 2.5, z: 0 });
            viz.createLabel('RANK', { x: 1.5, y: 2.5, z: 0 });
            viz.createLabel('RANK() - Same rank for ties, gaps after', { x: 0, y: -2, z: 0 });
            viz.createGrid(10, 10);
        }

        function showRunningSum() {
            viz.clear();
            
            const rows = [
                { y: 1.5, value: 10, sum: 10 },
                { y: 0.7, value: 20, sum: 30 },
                { y: -0.1, value: 15, sum: 45 },
                { y: -0.9, value: 25, sum: 70 }
            ];

            rows.forEach(r => {
                viz.createDataNode({
                    type: 'cube', size: 0.5, color: 0xe25a1c,
                    position: { x: -1.5, y: r.y, z: 0 }
                });
                viz.createLabel(r.value.toString(), { x: 0, y: r.y, z: 0 });
                viz.createDataNode({
                    type: 'cube', size: 0.5, color: 0x198754,
                    position: { x: 1.5, y: r.y, z: 0 }
                });
                viz.createLabel(r.sum.toString(), { x: 2.5, y: r.y, z: 0 });
            });

            viz.createLabel('Value', { x: -0.5, y: 2.5, z: 0 });
            viz.createLabel('Running Sum', { x: 2, y: 2.5, z: 0 });
            viz.createLabel('SUM() OVER - Cumulative total', { x: 0, y: -2, z: 0 });
            viz.createGrid(10, 10);
        }

        function showLeadLag() {
            viz.clear();
            
            const rows = [
                { y: 1.5, value: 100, lag: 'NULL', lead: 120 },
                { y: 0.7, value: 120, lag: 100, lead: 115 },
                { y: -0.1, value: 115, lag: 120, lead: 130 },
                { y: -0.9, value: 130, lag: 115, lead: 'NULL' }
            ];

            rows.forEach(r => {
                viz.createLabel(r.lag.toString(), { x: -2, y: r.y, z: 0 });
                viz.createDataNode({
                    type: 'cube', size: 0.5, color: 0x4dabf7,
                    position: { x: 0, y: r.y, z: 0 }
                });
                viz.createLabel(r.value.toString(), { x: 0.8, y: r.y, z: 0 });
                viz.createLabel(r.lead.toString(), { x: 2.5, y: r.y, z: 0 });
            });

            viz.createLabel('LAG', { x: -2, y: 2.5, z: 0 });
            viz.createLabel('Current', { x: 0.5, y: 2.5, z: 0 });
            viz.createLabel('LEAD', { x: 2.5, y: 2.5, z: 0 });
            viz.createLabel('LEAD/LAG - Access adjacent rows', { x: 0, y: -2, z: 0 });
            viz.createGrid(10, 10);
        }
    </script>
</body>
</html>
