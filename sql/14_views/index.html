<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Views - SQL Learning Hub</title>
    <link rel="stylesheet" href="../../assets/css/main.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
</head>
<body>
    <header class="header">
        <div class="container header-content">
            <a href="../../index.html" class="logo"><span>Data Engineering Hub</span></a>
            <nav class="nav"><a href="../../index.html#sql" class="nav-link active">SQL</a><button class="theme-toggle">ðŸŒ™</button></nav>
        </div>
    </header>
    <main class="container">
        <section class="section">
            <h1>Views</h1>
            <p>Views are virtual tables based on SELECT queries. Learn views using standard SQL, PySpark DataFrame API, and PySpark SQL.</p>
            <div id="visualization" class="visualization-container"></div>
            <div class="visualization-controls">
                <button class="viz-btn" onclick="showView()">View</button>
                <button class="viz-btn" onclick="showMaterialized()">Materialized</button>
            </div>
            <h2>Code Examples</h2>
            <div class="tabs">
                <button class="tab active" data-tab="sql">Standard SQL</button>
                <button class="tab" data-tab="pyspark-df">PySpark DataFrame</button>
                <button class="tab" data-tab="pyspark-sql">PySpark SQL</button>
                <button class="tab" data-tab="comparison">Side-by-Side</button>
            </div>
            <div class="tab-contents">
                <div id="sql" class="tab-content active">
                    <div class="code-container">
                        <div class="code-header"><span class="code-language">SQL</span><button class="copy-btn">Copy</button></div>
                        <div class="code-block">
<pre>-- Create simple view
CREATE VIEW active_employees AS
SELECT employee_id, first_name, last_name, department_id
FROM employees WHERE status = 'Active';

-- Use view like a table
SELECT * FROM active_employees;

-- Create or replace view
CREATE OR REPLACE VIEW active_employees AS
SELECT employee_id, first_name, last_name, department_id, hire_date
FROM employees WHERE status = 'Active';

-- View with aggregation
CREATE VIEW dept_stats AS
SELECT department_id, COUNT(*) AS emp_count, AVG(salary) AS avg_salary
FROM employees GROUP BY department_id;

-- Drop view
DROP VIEW IF EXISTS active_employees;</pre>
                        </div>
                    </div>
                </div>
                <div id="pyspark-df" class="tab-content">
                    <div class="code-container">
                        <div class="code-header"><span class="code-language">Python (PySpark DataFrame API)</span><button class="copy-btn">Copy</button></div>
                        <div class="code-block">
<pre>from pyspark.sql import SparkSession
from pyspark.sql.functions import col, count, avg, sum

spark = SparkSession.builder.appName("Views").getOrCreate()

# Create sample DataFrame
data = [
    (1, "Alice", "Smith", 50000, 10, "Active"),
    (2, "Bob", "Johnson", 60000, 20, "Active"),
    (3, "Charlie", "Brown", 75000, 10, "Inactive"),
    (4, "Diana", "Wilson", 55000, 20, "Active")
]
df = spark.createDataFrame(data, ["id", "first_name", "last_name", "salary", "dept_id", "status"])

# Create temporary view (session-scoped)
df.createOrReplaceTempView("employees")

# Create view from filtered DataFrame
active_employees = df.filter(col("status") == "Active")
active_employees.createOrReplaceTempView("active_employees")

# Use view
spark.sql("SELECT * FROM active_employees").show()

# Create global temporary view (application-scoped)
df.createOrReplaceGlobalTempView("global_employees")
# Access with global_temp prefix
spark.sql("SELECT * FROM global_temp.global_employees").show()

# View with aggregation
dept_stats = df.groupBy("dept_id").agg(
    count("*").alias("emp_count"),
    avg("salary").alias("avg_salary"),
    sum("salary").alias("total_salary")
)
dept_stats.createOrReplaceTempView("dept_stats")

# View with joins
departments = spark.createDataFrame([(10, "IT"), (20, "HR")], ["dept_id", "dept_name"])
departments.createOrReplaceTempView("departments")

employee_details = df.join(departments, "dept_id")
employee_details.createOrReplaceTempView("employee_details")

# List all views
spark.catalog.listTables()

# Drop view
spark.catalog.dropTempView("active_employees")
spark.catalog.dropGlobalTempView("global_employees")

# Check if view exists
spark.catalog.tableExists("employees")</pre>
                        </div>
                    </div>
                </div>
                <div id="pyspark-sql" class="tab-content">
                    <div class="code-container">
                        <div class="code-header"><span class="code-language">Python (PySpark SQL)</span><button class="copy-btn">Copy</button></div>
                        <div class="code-block">
<pre>from pyspark.sql import SparkSession

spark = SparkSession.builder.appName("Views").getOrCreate()

# Create base table
data = [
    (1, "Alice", "Smith", 50000, 10, "Active"),
    (2, "Bob", "Johnson", 60000, 20, "Active"),
    (3, "Charlie", "Brown", 75000, 10, "Inactive")
]
df = spark.createDataFrame(data, ["id", "first_name", "last_name", "salary", "dept_id", "status"])
df.createOrReplaceTempView("employees")

# Create view using SQL
spark.sql("""
    CREATE OR REPLACE TEMP VIEW active_employees AS
    SELECT id, first_name, last_name, dept_id
    FROM employees
    WHERE status = 'Active'
""")

# Use view
spark.sql("SELECT * FROM active_employees").show()

# Create view with aggregation
spark.sql("""
    CREATE OR REPLACE TEMP VIEW dept_stats AS
    SELECT dept_id, COUNT(*) AS emp_count, AVG(salary) AS avg_salary
    FROM employees
    GROUP BY dept_id
""")
spark.sql("SELECT * FROM dept_stats").show()

# Create global temporary view
spark.sql("""
    CREATE OR REPLACE GLOBAL TEMP VIEW global_active AS
    SELECT * FROM employees WHERE status = 'Active'
""")
spark.sql("SELECT * FROM global_temp.global_active").show()

# View with joins
spark.sql("""
    CREATE OR REPLACE TEMP VIEW departments AS
    SELECT 10 AS dept_id, 'IT' AS dept_name
    UNION ALL
    SELECT 20, 'HR'
""")

spark.sql("""
    CREATE OR REPLACE TEMP VIEW employee_details AS
    SELECT e.*, d.dept_name
    FROM employees e
    JOIN departments d ON e.dept_id = d.dept_id
""")

# Show all tables/views
spark.sql("SHOW TABLES").show()
spark.sql("SHOW VIEWS").show()

# Describe view
spark.sql("DESCRIBE active_employees").show()

# Drop view
spark.sql("DROP VIEW IF EXISTS active_employees")</pre>
                        </div>
                    </div>
                </div>
                <div id="comparison" class="tab-content">
                    <div class="code-container">
                        <div class="code-header"><span class="code-language">Side-by-Side Comparison</span><button class="copy-btn">Copy</button></div>
                        <div class="code-block">
<pre># ============================================
# VIEWS: DataFrame API vs SQL
# ============================================
from pyspark.sql import SparkSession
from pyspark.sql.functions import col

spark = SparkSession.builder.appName("Comparison").getOrCreate()

data = [(1, "Alice", 50000, "Active"), (2, "Bob", 60000, "Inactive")]
df = spark.createDataFrame(data, ["id", "name", "salary", "status"])

# CREATE TEMP VIEW
# DataFrame API:
df.createOrReplaceTempView("employees")
# PySpark SQL:
spark.sql("CREATE OR REPLACE TEMP VIEW employees_sql AS SELECT * FROM employees")

# CREATE VIEW FROM FILTERED DATA
# DataFrame API:
df.filter(col("status") == "Active").createOrReplaceTempView("active_df")
# PySpark SQL:
spark.sql("CREATE OR REPLACE TEMP VIEW active_sql AS SELECT * FROM employees WHERE status = 'Active'")

# CREATE GLOBAL TEMP VIEW
# DataFrame API:
df.createOrReplaceGlobalTempView("global_df")
# PySpark SQL:
spark.sql("CREATE OR REPLACE GLOBAL TEMP VIEW global_sql AS SELECT * FROM employees")

# DROP VIEW
# DataFrame API:
spark.catalog.dropTempView("active_df")
# PySpark SQL:
spark.sql("DROP VIEW IF EXISTS active_sql")

# Note: PySpark views are temporary by default (session or app scoped)
# For persistent views, use Hive metastore or Delta Lake</pre>
                        </div>
                    </div>
                </div>
            </div>
            <div style="display: flex; justify-content: space-between; margin-top: 3rem; padding-top: 2rem; border-top: 1px solid var(--border-color);">
                <a href="../13_indexes_performance/index.html" style="color: var(--text-muted);">&larr; Previous: Indexes & Performance</a>
                <a href="../15_stored_procedures/index.html" style="color: var(--accent-primary);">Next: Stored Procedures &rarr;</a>
            </div>
        </section>
    </main>
    <script src="../../assets/js/main.js"></script>
    <script src="../../assets/js/visualization.js"></script>
    <script>
        let viz;
        document.addEventListener('DOMContentLoaded', function() {
            viz = new DataVisualization('visualization', { cameraPosition: { x: 5, y: 3, z: 5 } });
            showView();
        });
        function showView() {
            viz.clear();
            // Base table
            for (let i = 0; i < 4; i++) {
                for (let j = 0; j < 3; j++) {
                    viz.createDataNode({ type: 'cube', size: 0.3, color: 0x4dabf7, position: { x: -2 + j * 0.5, y: 1 - i * 0.5, z: 0 } });
                }
            }
            viz.createLabel('Table', { x: -1.5, y: 1.8, z: 0 });
            // View (subset)
            for (let i = 0; i < 2; i++) {
                for (let j = 0; j < 2; j++) {
                    viz.createDataNode({ type: 'cube', size: 0.3, color: 0xe25a1c, position: { x: 1.5 + j * 0.5, y: 0.5 - i * 0.5, z: 0 } });
                }
            }
            viz.createLabel('View', { x: 1.75, y: 1.3, z: 0 });
            viz.createArrow({ x: -0.5, y: 0.3, z: 0 }, { x: 1, y: 0.3, z: 0 }, { color: 0x888888 });
            viz.createLabel('View - Virtual table from query', { x: 0, y: -1.8, z: 0 });
            viz.createGrid(10, 10);
        }
        function showMaterialized() {
            viz.clear();
            viz.createDataNode({ type: 'cube', size: 0.8, color: 0x4dabf7, position: { x: -1.5, y: 0.5, z: 0 } });
            viz.createLabel('Query', { x: -1.5, y: 1.4, z: 0 });
            viz.createArrow({ x: -0.8, y: 0.5, z: 0 }, { x: 0.8, y: 0.5, z: 0 }, { color: 0x888888 });
            viz.createDataNode({ type: 'cylinder', size: 0.6, color: 0xe25a1c, position: { x: 1.5, y: 0.5, z: 0 } });
            viz.createLabel('Stored Data', { x: 1.5, y: 1.4, z: 0 });
            viz.createLabel('Materialized View - Cached results', { x: 0, y: -1.5, z: 0 });
            viz.createGrid(10, 10);
        }
    </script>
</body>
</html>
