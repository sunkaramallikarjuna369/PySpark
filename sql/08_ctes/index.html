<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CTEs (Common Table Expressions) - SQL Learning Hub</title>
    <link rel="stylesheet" href="../../assets/css/main.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
</head>
<body>
    <header class="header">
        <div class="container header-content">
            <a href="../../index.html" class="logo"><span>Data Engineering Hub</span></a>
            <nav class="nav"><a href="../../index.html#sql" class="nav-link active">SQL</a><button class="theme-toggle">ðŸŒ™</button></nav>
        </div>
    </header>
    <main class="container">
        <section class="section">
            <h1>CTEs (Common Table Expressions)</h1>
            <p>CTEs provide a way to write auxiliary statements for use in a larger query. Learn CTEs using standard SQL, PySpark DataFrame API, and PySpark SQL.</p>
            <div id="visualization" class="visualization-container"></div>
            <div class="visualization-controls">
                <button class="viz-btn" onclick="showCTE()">Basic CTE</button>
                <button class="viz-btn" onclick="showRecursive()">Recursive</button>
            </div>
            <h2>Code Examples</h2>
            <div class="tabs">
                <button class="tab active" data-tab="sql">Standard SQL</button>
                <button class="tab" data-tab="pyspark-df">PySpark DataFrame</button>
                <button class="tab" data-tab="pyspark-sql">PySpark SQL</button>
                <button class="tab" data-tab="comparison">Side-by-Side</button>
            </div>
            <div class="tab-contents">
                <div id="sql" class="tab-content active">
                    <div class="code-container">
                        <div class="code-header"><span class="code-language">SQL</span><button class="copy-btn">Copy</button></div>
                        <div class="code-block">
<pre>-- Basic CTE
WITH dept_stats AS (
    SELECT department_id, COUNT(*) AS emp_count, AVG(salary) AS avg_salary
    FROM employees GROUP BY department_id
)
SELECT * FROM dept_stats WHERE avg_salary > 50000;

-- Multiple CTEs
WITH 
dept_stats AS (
    SELECT department_id, AVG(salary) AS avg_salary
    FROM employees GROUP BY department_id
),
high_paying_depts AS (
    SELECT department_id FROM dept_stats WHERE avg_salary > 60000
)
SELECT * FROM high_paying_depts;

-- CTE referenced multiple times
WITH dept_avg AS (
    SELECT department_id, AVG(salary) AS avg_sal
    FROM employees GROUP BY department_id
)
SELECT e.first_name, e.salary, d.avg_sal
FROM employees e JOIN dept_avg d ON e.department_id = d.department_id;</pre>
                        </div>
                    </div>
                </div>
                <div id="pyspark-df" class="tab-content">
                    <div class="code-container">
                        <div class="code-header"><span class="code-language">Python (PySpark DataFrame API)</span><button class="copy-btn">Copy</button></div>
                        <div class="code-block">
<pre>from pyspark.sql import SparkSession
from pyspark.sql.functions import col, count, avg, sum

spark = SparkSession.builder.appName("CTEs").getOrCreate()

# Create sample DataFrame
data = [
    (1, "Alice", 50000, 10), (2, "Bob", 60000, 10),
    (3, "Charlie", 75000, 20), (4, "Diana", 55000, 20)
]
df = spark.createDataFrame(data, ["id", "name", "salary", "dept_id"])

# CTE equivalent - create intermediate DataFrames
# Basic CTE: dept_stats
dept_stats = df.groupBy("dept_id").agg(
    count("*").alias("emp_count"),
    avg("salary").alias("avg_salary")
)
dept_stats.filter(col("avg_salary") > 50000).show()

# Multiple CTEs equivalent - chain transformations
# CTE 1: dept_stats
dept_stats = df.groupBy("dept_id").agg(avg("salary").alias("avg_salary"))
# CTE 2: high_paying_depts (references dept_stats)
high_paying_depts = dept_stats.filter(col("avg_salary") > 55000).select("dept_id")
high_paying_depts.show()

# CTE referenced multiple times
dept_avg = df.groupBy("dept_id").agg(avg("salary").alias("avg_sal"))
# Use the same DataFrame multiple times
df.join(dept_avg, "dept_id") \
  .select("name", "salary", "avg_sal") \
  .withColumn("diff", col("salary") - col("avg_sal")).show()

# Cache for reuse (like CTE optimization)
dept_avg.cache()
result1 = df.join(dept_avg, "dept_id").filter(col("salary") > col("avg_sal"))
result2 = df.join(dept_avg, "dept_id").filter(col("salary") < col("avg_sal"))
result1.show()
result2.show()
dept_avg.unpersist()</pre>
                        </div>
                    </div>
                </div>
                <div id="pyspark-sql" class="tab-content">
                    <div class="code-container">
                        <div class="code-header"><span class="code-language">Python (PySpark SQL)</span><button class="copy-btn">Copy</button></div>
                        <div class="code-block">
<pre>from pyspark.sql import SparkSession

spark = SparkSession.builder.appName("CTEs").getOrCreate()

# Create and register temp view
data = [
    (1, "Alice", 50000, 10), (2, "Bob", 60000, 10),
    (3, "Charlie", 75000, 20), (4, "Diana", 55000, 20)
]
df = spark.createDataFrame(data, ["id", "name", "salary", "dept_id"])
df.createOrReplaceTempView("employees")

# Basic CTE
spark.sql("""
    WITH dept_stats AS (
        SELECT dept_id, COUNT(*) AS emp_count, AVG(salary) AS avg_salary
        FROM employees GROUP BY dept_id
    )
    SELECT * FROM dept_stats WHERE avg_salary > 50000
""").show()

# Multiple CTEs
spark.sql("""
    WITH 
    dept_stats AS (
        SELECT dept_id, AVG(salary) AS avg_salary
        FROM employees GROUP BY dept_id
    ),
    high_paying_depts AS (
        SELECT dept_id FROM dept_stats WHERE avg_salary > 55000
    )
    SELECT * FROM high_paying_depts
""").show()

# CTE referenced multiple times
spark.sql("""
    WITH dept_avg AS (
        SELECT dept_id, AVG(salary) AS avg_sal
        FROM employees GROUP BY dept_id
    )
    SELECT e.name, e.salary, d.avg_sal, e.salary - d.avg_sal AS diff
    FROM employees e
    JOIN dept_avg d ON e.dept_id = d.dept_id
""").show()

# CTEs referencing each other
spark.sql("""
    WITH 
    base AS (SELECT dept_id, salary FROM employees),
    totals AS (SELECT dept_id, SUM(salary) AS total FROM base GROUP BY dept_id)
    SELECT * FROM totals ORDER BY total DESC
""").show()</pre>
                        </div>
                    </div>
                </div>
                <div id="comparison" class="tab-content">
                    <div class="code-container">
                        <div class="code-header"><span class="code-language">Side-by-Side Comparison</span><button class="copy-btn">Copy</button></div>
                        <div class="code-block">
<pre># ============================================
# CTEs: DataFrame API vs SQL
# ============================================
from pyspark.sql import SparkSession
from pyspark.sql.functions import col, avg

spark = SparkSession.builder.appName("Comparison").getOrCreate()

data = [(1, "Alice", 50000, 10), (2, "Bob", 60000, 10), (3, "Charlie", 75000, 20)]
df = spark.createDataFrame(data, ["id", "name", "salary", "dept_id"])
df.createOrReplaceTempView("employees")

# BASIC CTE
# DataFrame API (CTE = intermediate DataFrame):
dept_stats = df.groupBy("dept_id").agg(avg("salary").alias("avg_sal"))
dept_stats.filter(col("avg_sal") > 55000).show()
# PySpark SQL:
spark.sql("""
    WITH dept_stats AS (SELECT dept_id, AVG(salary) AS avg_sal FROM employees GROUP BY dept_id)
    SELECT * FROM dept_stats WHERE avg_sal > 55000
""").show()

# CTE REFERENCED MULTIPLE TIMES
# DataFrame API (cache for reuse):
dept_avg = df.groupBy("dept_id").agg(avg("salary").alias("avg_sal"))
dept_avg.cache()
df.join(dept_avg, "dept_id").filter(col("salary") > col("avg_sal")).show()
# PySpark SQL:
spark.sql("""
    WITH dept_avg AS (SELECT dept_id, AVG(salary) AS avg_sal FROM employees GROUP BY dept_id)
    SELECT * FROM employees e JOIN dept_avg d ON e.dept_id = d.dept_id WHERE salary > avg_sal
""").show()</pre>
                        </div>
                    </div>
                </div>
            </div>
            <div style="display: flex; justify-content: space-between; margin-top: 3rem; padding-top: 2rem; border-top: 1px solid var(--border-color);">
                <a href="../07_subqueries/index.html" style="color: var(--text-muted);">&larr; Previous: Subqueries</a>
                <a href="../09_window_functions/index.html" style="color: var(--accent-primary);">Next: Window Functions &rarr;</a>
            </div>
        </section>
    </main>
    <script src="../../assets/js/main.js"></script>
    <script src="../../assets/js/visualization.js"></script>
    <script>
        let viz;
        document.addEventListener('DOMContentLoaded', function() {
            viz = new DataVisualization('visualization', { cameraPosition: { x: 5, y: 3, z: 5 } });
            showCTE();
        });
        function showCTE() {
            viz.clear();
            viz.createDataNode({ type: 'cube', size: 0.6, color: 0x4dabf7, position: { x: 0, y: 1.2, z: 0 } });
            viz.createLabel('CTE', { x: 0, y: 1.9, z: 0 });
            viz.createArrow({ x: 0, y: 0.7, z: 0 }, { x: 0, y: 0.1, z: 0 }, { color: 0x888888 });
            viz.createDataNode({ type: 'cube', size: 0.8, color: 0xe25a1c, position: { x: 0, y: -0.5, z: 0 } });
            viz.createLabel('Main Query', { x: 0, y: -1.3, z: 0 });
            viz.createLabel('CTE - Named temporary result', { x: 0, y: -2.3, z: 0 });
            viz.createGrid(10, 10);
        }
        function showRecursive() {
            viz.clear();
            for (let i = 0; i < 4; i++) {
                viz.createDataNode({ type: 'sphere', size: 0.3, color: 0x4dabf7, position: { x: 0, y: 1.5 - i * 0.8, z: 0 } });
                if (i > 0) viz.createArrow({ x: 0, y: 1.5 - (i-1) * 0.8 - 0.3, z: 0 }, { x: 0, y: 1.5 - i * 0.8 + 0.3, z: 0 }, { color: 0x888888 });
            }
            viz.createLabel('Recursive CTE - Self-referencing', { x: 0, y: -2, z: 0 });
            viz.createGrid(10, 10);
        }
    </script>
</body>
</html>
