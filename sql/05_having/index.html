<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HAVING Clause - SQL Learning Hub</title>
    <link rel="stylesheet" href="../../assets/css/main.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
</head>
<body>
    <header class="header">
        <div class="container header-content">
            <a href="../../index.html" class="logo"><span>Data Engineering Hub</span></a>
            <nav class="nav"><a href="../../index.html#sql" class="nav-link active">SQL</a><button class="theme-toggle">ðŸŒ™</button></nav>
        </div>
    </header>
    <main class="container">
        <section class="section">
            <h1>HAVING Clause</h1>
            <p>HAVING filters groups after GROUP BY aggregation. Learn HAVING using standard SQL, PySpark DataFrame API, and PySpark SQL.</p>
            <div id="visualization" class="visualization-container"></div>
            <div class="visualization-controls">
                <button class="viz-btn" onclick="showWhereVsHaving()">WHERE vs HAVING</button>
            </div>
            <h2>Code Examples</h2>
            <div class="tabs">
                <button class="tab active" data-tab="sql">Standard SQL</button>
                <button class="tab" data-tab="pyspark-df">PySpark DataFrame</button>
                <button class="tab" data-tab="pyspark-sql">PySpark SQL</button>
                <button class="tab" data-tab="comparison">Side-by-Side</button>
            </div>
            <div class="tab-contents">
                <div id="sql" class="tab-content active">
                    <div class="code-container">
                        <div class="code-header"><span class="code-language">SQL</span><button class="copy-btn">Copy</button></div>
                        <div class="code-block">
<pre>-- Basic HAVING
SELECT department_id, COUNT(*) AS emp_count
FROM employees GROUP BY department_id HAVING COUNT(*) > 5;

-- HAVING with SUM
SELECT department_id, SUM(salary) AS total_salary
FROM employees GROUP BY department_id HAVING SUM(salary) > 100000;

-- HAVING with AVG
SELECT department_id, AVG(salary) AS avg_salary
FROM employees GROUP BY department_id HAVING AVG(salary) > 50000;

-- WHERE and HAVING together
SELECT department_id, COUNT(*) AS count
FROM employees
WHERE salary > 30000
GROUP BY department_id
HAVING COUNT(*) > 3;

-- Multiple HAVING conditions
SELECT department_id, COUNT(*) AS count, AVG(salary) AS avg_sal
FROM employees GROUP BY department_id
HAVING COUNT(*) > 5 AND AVG(salary) > 50000;</pre>
                        </div>
                    </div>
                </div>
                <div id="pyspark-df" class="tab-content">
                    <div class="code-container">
                        <div class="code-header"><span class="code-language">Python (PySpark DataFrame API)</span><button class="copy-btn">Copy</button></div>
                        <div class="code-block">
<pre>from pyspark.sql import SparkSession
from pyspark.sql.functions import col, count, sum, avg

spark = SparkSession.builder.appName("Having").getOrCreate()

# Create sample DataFrame
data = [
    (1, "Alice", 50000, 10), (2, "Bob", 60000, 10),
    (3, "Charlie", 75000, 10), (4, "Diana", 55000, 20),
    (5, "Eve", 45000, 20), (6, "Frank", 80000, 30)
]
df = spark.createDataFrame(data, ["id", "name", "salary", "dept_id"])

# Basic HAVING - filter groups with count > 2
df.groupBy("dept_id").agg(
    count("*").alias("emp_count")
).filter(col("emp_count") > 2).show()

# HAVING with SUM
df.groupBy("dept_id").agg(
    sum("salary").alias("total_salary")
).filter(col("total_salary") > 100000).show()

# HAVING with AVG
df.groupBy("dept_id").agg(
    avg("salary").alias("avg_salary")
).filter(col("avg_salary") > 50000).show()

# WHERE and HAVING together
df.filter(col("salary") > 30000) \
  .groupBy("dept_id") \
  .agg(count("*").alias("count")) \
  .filter(col("count") > 1).show()

# Multiple HAVING conditions
df.groupBy("dept_id").agg(
    count("*").alias("count"),
    avg("salary").alias("avg_sal")
).filter((col("count") > 1) & (col("avg_sal") > 50000)).show()

# HAVING with subquery equivalent
overall_avg = df.agg(avg("salary")).collect()[0][0]
df.groupBy("dept_id").agg(
    avg("salary").alias("avg_sal")
).filter(col("avg_sal") > overall_avg).show()</pre>
                        </div>
                    </div>
                </div>
                <div id="pyspark-sql" class="tab-content">
                    <div class="code-container">
                        <div class="code-header"><span class="code-language">Python (PySpark SQL)</span><button class="copy-btn">Copy</button></div>
                        <div class="code-block">
<pre>from pyspark.sql import SparkSession

spark = SparkSession.builder.appName("Having").getOrCreate()

# Create and register temp view
data = [
    (1, "Alice", 50000, 10), (2, "Bob", 60000, 10),
    (3, "Charlie", 75000, 10), (4, "Diana", 55000, 20),
    (5, "Eve", 45000, 20), (6, "Frank", 80000, 30)
]
df = spark.createDataFrame(data, ["id", "name", "salary", "dept_id"])
df.createOrReplaceTempView("employees")

# Basic HAVING
spark.sql("""
    SELECT dept_id, COUNT(*) AS emp_count
    FROM employees GROUP BY dept_id HAVING COUNT(*) > 2
""").show()

# HAVING with SUM
spark.sql("""
    SELECT dept_id, SUM(salary) AS total_salary
    FROM employees GROUP BY dept_id HAVING SUM(salary) > 100000
""").show()

# HAVING with AVG
spark.sql("""
    SELECT dept_id, AVG(salary) AS avg_salary
    FROM employees GROUP BY dept_id HAVING AVG(salary) > 50000
""").show()

# WHERE and HAVING together
spark.sql("""
    SELECT dept_id, COUNT(*) AS count
    FROM employees
    WHERE salary > 30000
    GROUP BY dept_id
    HAVING COUNT(*) > 1
""").show()

# Multiple HAVING conditions
spark.sql("""
    SELECT dept_id, COUNT(*) AS count, AVG(salary) AS avg_sal
    FROM employees GROUP BY dept_id
    HAVING COUNT(*) > 1 AND AVG(salary) > 50000
""").show()

# HAVING with subquery
spark.sql("""
    SELECT dept_id, AVG(salary) AS avg_sal
    FROM employees GROUP BY dept_id
    HAVING AVG(salary) > (SELECT AVG(salary) FROM employees)
""").show()</pre>
                        </div>
                    </div>
                </div>
                <div id="comparison" class="tab-content">
                    <div class="code-container">
                        <div class="code-header"><span class="code-language">Side-by-Side Comparison</span><button class="copy-btn">Copy</button></div>
                        <div class="code-block">
<pre># ============================================
# HAVING: DataFrame API vs SQL
# ============================================
from pyspark.sql import SparkSession
from pyspark.sql.functions import col, count, avg

spark = SparkSession.builder.appName("Comparison").getOrCreate()

data = [(1, "Alice", 50000, 10), (2, "Bob", 60000, 10), (3, "Charlie", 75000, 20)]
df = spark.createDataFrame(data, ["id", "name", "salary", "dept_id"])
df.createOrReplaceTempView("employees")

# BASIC HAVING
# DataFrame API:
df.groupBy("dept_id").agg(count("*").alias("cnt")).filter(col("cnt") > 1).show()
# PySpark SQL:
spark.sql("SELECT dept_id, COUNT(*) AS cnt FROM employees GROUP BY dept_id HAVING COUNT(*) > 1").show()

# HAVING WITH AVG
# DataFrame API:
df.groupBy("dept_id").agg(avg("salary").alias("avg_sal")).filter(col("avg_sal") > 55000).show()
# PySpark SQL:
spark.sql("SELECT dept_id, AVG(salary) AS avg_sal FROM employees GROUP BY dept_id HAVING AVG(salary) > 55000").show()

# WHERE + HAVING
# DataFrame API:
df.filter(col("salary") > 40000).groupBy("dept_id").agg(count("*").alias("cnt")).filter(col("cnt") > 1).show()
# PySpark SQL:
spark.sql("SELECT dept_id, COUNT(*) AS cnt FROM employees WHERE salary > 40000 GROUP BY dept_id HAVING COUNT(*) > 1").show()</pre>
                        </div>
                    </div>
                </div>
            </div>
            <div style="display: flex; justify-content: space-between; margin-top: 3rem; padding-top: 2rem; border-top: 1px solid var(--border-color);">
                <a href="../04_group_by/index.html" style="color: var(--text-muted);">&larr; Previous: GROUP BY</a>
                <a href="../06_order_by/index.html" style="color: var(--accent-primary);">Next: ORDER BY &rarr;</a>
            </div>
        </section>
    </main>
    <script src="../../assets/js/main.js"></script>
    <script src="../../assets/js/visualization.js"></script>
    <script>
        let viz;
        document.addEventListener('DOMContentLoaded', function() {
            viz = new DataVisualization('visualization', { cameraPosition: { x: 5, y: 3, z: 5 } });
            showWhereVsHaving();
        });
        function showWhereVsHaving() {
            viz.clear();
            // WHERE filters rows
            for (let i = 0; i < 5; i++) {
                viz.createDataNode({ type: 'cube', size: 0.3, color: i < 3 ? 0x4dabf7 : 0x333333, position: { x: -2, y: 1.5 - i * 0.6, z: 0 } });
            }
            viz.createLabel('WHERE', { x: -2, y: 2.3, z: 0 });
            // GROUP BY
            viz.createDataNode({ type: 'sphere', size: 0.5, color: 0xe25a1c, position: { x: 0, y: 0.8, z: 0 } });
            viz.createDataNode({ type: 'sphere', size: 0.5, color: 0x198754, position: { x: 0, y: 0, z: 0 } });
            viz.createLabel('GROUP', { x: 0, y: 1.8, z: 0 });
            // HAVING filters groups
            viz.createDataNode({ type: 'sphere', size: 0.5, color: 0xe25a1c, position: { x: 2, y: 0.5, z: 0 } });
            viz.createLabel('HAVING', { x: 2, y: 1.5, z: 0 });
            viz.createArrow({ x: -1.3, y: 0.5, z: 0 }, { x: -0.5, y: 0.5, z: 0 }, { color: 0x888888 });
            viz.createArrow({ x: 0.5, y: 0.5, z: 0 }, { x: 1.3, y: 0.5, z: 0 }, { color: 0x888888 });
            viz.createLabel('WHERE filters rows, HAVING filters groups', { x: 0, y: -2, z: 0 });
            viz.createGrid(10, 10);
        }
    </script>
</body>
</html>
