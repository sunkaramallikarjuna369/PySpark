<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UNION & Set Operations - SQL Learning Hub</title>
    <link rel="stylesheet" href="../../assets/css/main.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
</head>
<body>
    <header class="header">
        <div class="container header-content">
            <a href="../../index.html" class="logo"><span>Data Engineering Hub</span></a>
            <nav class="nav"><a href="../../index.html#sql" class="nav-link active">SQL</a><button class="theme-toggle">ðŸŒ™</button></nav>
        </div>
    </header>
    <main class="container">
        <section class="section">
            <h1>UNION & Set Operations</h1>
            <p>Set operations combine results from multiple SELECT statements. Learn UNION, INTERSECT, and EXCEPT using standard SQL, PySpark DataFrame API, and PySpark SQL.</p>
            <div id="visualization" class="visualization-container"></div>
            <div class="visualization-controls">
                <button class="viz-btn" onclick="showUnion()">UNION</button>
                <button class="viz-btn" onclick="showIntersect()">INTERSECT</button>
                <button class="viz-btn" onclick="showExcept()">EXCEPT</button>
            </div>
            <h2>Code Examples</h2>
            <div class="tabs">
                <button class="tab active" data-tab="sql">Standard SQL</button>
                <button class="tab" data-tab="pyspark-df">PySpark DataFrame</button>
                <button class="tab" data-tab="pyspark-sql">PySpark SQL</button>
                <button class="tab" data-tab="comparison">Side-by-Side</button>
            </div>
            <div class="tab-contents">
                <div id="sql" class="tab-content active">
                    <div class="code-container">
                        <div class="code-header"><span class="code-language">SQL</span><button class="copy-btn">Copy</button></div>
                        <div class="code-block">
<pre>-- UNION (removes duplicates)
SELECT first_name, last_name FROM employees
UNION
SELECT first_name, last_name FROM contractors;

-- UNION ALL (keeps duplicates, faster)
SELECT first_name, last_name FROM employees
UNION ALL
SELECT first_name, last_name FROM contractors;

-- INTERSECT (rows in both queries)
SELECT employee_id FROM employees
INTERSECT
SELECT employee_id FROM project_assignments;

-- EXCEPT / MINUS (rows in first but not second)
SELECT employee_id FROM employees
EXCEPT
SELECT employee_id FROM terminated_employees;</pre>
                        </div>
                    </div>
                </div>
                <div id="pyspark-df" class="tab-content">
                    <div class="code-container">
                        <div class="code-header"><span class="code-language">Python (PySpark DataFrame API)</span><button class="copy-btn">Copy</button></div>
                        <div class="code-block">
<pre>from pyspark.sql import SparkSession

spark = SparkSession.builder.appName("SetOperations").getOrCreate()

# Create sample DataFrames
employees = spark.createDataFrame([
    (1, "Alice", "Smith"), (2, "Bob", "Johnson"), (3, "Charlie", "Brown")
], ["id", "first_name", "last_name"])

contractors = spark.createDataFrame([
    (4, "Diana", "Wilson"), (2, "Bob", "Johnson"), (5, "Eve", "Davis")
], ["id", "first_name", "last_name"])

# UNION (removes duplicates)
employees.select("first_name", "last_name") \
    .union(contractors.select("first_name", "last_name")) \
    .distinct().show()

# UNION ALL (keeps duplicates) - union() in PySpark keeps duplicates by default
employees.select("first_name", "last_name") \
    .union(contractors.select("first_name", "last_name")).show()

# unionByName - matches columns by name, not position
employees.unionByName(contractors).show()

# INTERSECT (rows in both)
employees.select("first_name", "last_name") \
    .intersect(contractors.select("first_name", "last_name")).show()

# INTERSECT ALL (keeps duplicates)
employees.select("first_name", "last_name") \
    .intersectAll(contractors.select("first_name", "last_name")).show()

# EXCEPT (rows in first but not second)
employees.select("first_name", "last_name") \
    .subtract(contractors.select("first_name", "last_name")).show()

# EXCEPT ALL (keeps duplicates)
employees.select("first_name", "last_name") \
    .exceptAll(contractors.select("first_name", "last_name")).show()

# Multiple unions
interns = spark.createDataFrame([(6, "Frank", "Miller")], ["id", "first_name", "last_name"])
employees.union(contractors).union(interns).distinct().show()</pre>
                        </div>
                    </div>
                </div>
                <div id="pyspark-sql" class="tab-content">
                    <div class="code-container">
                        <div class="code-header"><span class="code-language">Python (PySpark SQL)</span><button class="copy-btn">Copy</button></div>
                        <div class="code-block">
<pre>from pyspark.sql import SparkSession

spark = SparkSession.builder.appName("SetOperations").getOrCreate()

# Create and register temp views
employees = spark.createDataFrame([
    (1, "Alice", "Smith"), (2, "Bob", "Johnson"), (3, "Charlie", "Brown")
], ["id", "first_name", "last_name"])
employees.createOrReplaceTempView("employees")

contractors = spark.createDataFrame([
    (4, "Diana", "Wilson"), (2, "Bob", "Johnson"), (5, "Eve", "Davis")
], ["id", "first_name", "last_name"])
contractors.createOrReplaceTempView("contractors")

# UNION (removes duplicates)
spark.sql("""
    SELECT first_name, last_name FROM employees
    UNION
    SELECT first_name, last_name FROM contractors
""").show()

# UNION ALL (keeps duplicates)
spark.sql("""
    SELECT first_name, last_name FROM employees
    UNION ALL
    SELECT first_name, last_name FROM contractors
""").show()

# INTERSECT
spark.sql("""
    SELECT first_name, last_name FROM employees
    INTERSECT
    SELECT first_name, last_name FROM contractors
""").show()

# EXCEPT
spark.sql("""
    SELECT first_name, last_name FROM employees
    EXCEPT
    SELECT first_name, last_name FROM contractors
""").show()

# Multiple set operations
spark.sql("""
    (SELECT first_name FROM employees
     UNION
     SELECT first_name FROM contractors)
    ORDER BY first_name
""").show()</pre>
                        </div>
                    </div>
                </div>
                <div id="comparison" class="tab-content">
                    <div class="code-container">
                        <div class="code-header"><span class="code-language">Side-by-Side Comparison</span><button class="copy-btn">Copy</button></div>
                        <div class="code-block">
<pre># ============================================
# SET OPERATIONS: DataFrame API vs SQL
# ============================================
from pyspark.sql import SparkSession

spark = SparkSession.builder.appName("Comparison").getOrCreate()

df1 = spark.createDataFrame([(1, "A"), (2, "B"), (3, "C")], ["id", "name"])
df2 = spark.createDataFrame([(2, "B"), (3, "C"), (4, "D")], ["id", "name"])
df1.createOrReplaceTempView("table1")
df2.createOrReplaceTempView("table2")

# UNION (distinct)
# DataFrame API:
df1.union(df2).distinct().show()
# PySpark SQL:
spark.sql("SELECT * FROM table1 UNION SELECT * FROM table2").show()

# UNION ALL (with duplicates)
# DataFrame API:
df1.union(df2).show()
# PySpark SQL:
spark.sql("SELECT * FROM table1 UNION ALL SELECT * FROM table2").show()

# INTERSECT
# DataFrame API:
df1.intersect(df2).show()
# PySpark SQL:
spark.sql("SELECT * FROM table1 INTERSECT SELECT * FROM table2").show()

# EXCEPT (MINUS)
# DataFrame API:
df1.subtract(df2).show()  # Note: subtract() not except()
# PySpark SQL:
spark.sql("SELECT * FROM table1 EXCEPT SELECT * FROM table2").show()</pre>
                        </div>
                    </div>
                </div>
            </div>
            <div style="display: flex; justify-content: space-between; margin-top: 3rem; padding-top: 2rem; border-top: 1px solid var(--border-color);">
                <a href="../09_window_functions/index.html" style="color: var(--text-muted);">&larr; Previous: Window Functions</a>
                <a href="../11_case_statements/index.html" style="color: var(--accent-primary);">Next: CASE Statements &rarr;</a>
            </div>
        </section>
    </main>
    <script src="../../assets/js/main.js"></script>
    <script src="../../assets/js/visualization.js"></script>
    <script>
        let viz;
        document.addEventListener('DOMContentLoaded', function() {
            viz = new DataVisualization('visualization', { cameraPosition: { x: 5, y: 3, z: 5 } });
            showUnion();
        });
        function showUnion() {
            viz.clear();
            viz.createDataNode({ type: 'sphere', size: 0.8, color: 0x4dabf7, position: { x: -0.5, y: 0.5, z: 0 } });
            viz.createDataNode({ type: 'sphere', size: 0.8, color: 0xe25a1c, position: { x: 0.5, y: 0.5, z: 0 } });
            viz.createLabel('A', { x: -1.2, y: 1.2, z: 0 });
            viz.createLabel('B', { x: 1.2, y: 1.2, z: 0 });
            viz.createLabel('UNION - All rows from both', { x: 0, y: -1.5, z: 0 });
            viz.createGrid(10, 10);
        }
        function showIntersect() {
            viz.clear();
            viz.createDataNode({ type: 'sphere', size: 0.8, color: 0x333333, position: { x: -0.5, y: 0.5, z: 0 } });
            viz.createDataNode({ type: 'sphere', size: 0.8, color: 0x333333, position: { x: 0.5, y: 0.5, z: 0 } });
            viz.createDataNode({ type: 'sphere', size: 0.4, color: 0x198754, position: { x: 0, y: 0.5, z: 0 } });
            viz.createLabel('INTERSECT - Only common rows', { x: 0, y: -1.5, z: 0 });
            viz.createGrid(10, 10);
        }
        function showExcept() {
            viz.clear();
            viz.createDataNode({ type: 'sphere', size: 0.8, color: 0xe25a1c, position: { x: -0.5, y: 0.5, z: 0 } });
            viz.createDataNode({ type: 'sphere', size: 0.8, color: 0x333333, position: { x: 0.5, y: 0.5, z: 0 } });
            viz.createLabel('EXCEPT - Rows in A but not B', { x: 0, y: -1.5, z: 0 });
            viz.createGrid(10, 10);
        }
    </script>
</body>
</html>
