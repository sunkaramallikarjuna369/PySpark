<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stored Procedures - SQL Learning Hub</title>
    <link rel="stylesheet" href="../../assets/css/main.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
</head>
<body>
    <header class="header">
        <div class="container header-content">
            <a href="../../index.html" class="logo"><span>Data Engineering Hub</span></a>
            <nav class="nav"><a href="../../index.html#sql" class="nav-link active">SQL</a><button class="theme-toggle">ðŸŒ™</button></nav>
        </div>
    </header>
    <main class="container">
        <section class="section">
            <h1>Stored Procedures</h1>
            <p>Stored procedures are precompiled SQL code that can be saved and reused. They encapsulate business logic, improve performance, and enhance security.</p>
            <div id="visualization" class="visualization-container"></div>
            <div class="visualization-controls">
                <button class="viz-btn" onclick="showProcedure()">Procedure</button>
                <button class="viz-btn" onclick="showFunction()">Function</button>
            </div>
            <h2>Code Examples</h2>
            <div class="tabs">
                <button class="tab active" data-tab="procedures">Procedures</button>
                <button class="tab" data-tab="functions">Functions</button>
                <button class="tab" data-tab="control">Control Flow</button>
            </div>
            <div class="tab-contents">
                <div id="procedures" class="tab-content active">
                    <div class="code-container">
                        <div class="code-header"><span class="code-language">SQL</span><button class="copy-btn">Copy</button></div>
                        <div class="code-block">
<pre>-- PostgreSQL Stored Procedure
CREATE OR REPLACE PROCEDURE update_salary(
    emp_id INT,
    new_salary DECIMAL
)
LANGUAGE plpgsql
AS $$
BEGIN
    UPDATE employees SET salary = new_salary WHERE employee_id = emp_id;
    COMMIT;
END;
$$;

-- Call procedure
CALL update_salary(101, 75000);

-- MySQL Stored Procedure
DELIMITER //
CREATE PROCEDURE GetEmployeesByDept(IN dept_id INT)
BEGIN
    SELECT * FROM employees WHERE department_id = dept_id;
END //
DELIMITER ;

-- Call MySQL procedure
CALL GetEmployeesByDept(10);

-- SQL Server Stored Procedure
CREATE PROCEDURE sp_GetEmployees
    @DeptId INT,
    @MinSalary DECIMAL = 0
AS
BEGIN
    SELECT * FROM employees 
    WHERE department_id = @DeptId AND salary >= @MinSalary;
END;

-- Execute SQL Server procedure
EXEC sp_GetEmployees @DeptId = 10, @MinSalary = 50000;

-- Drop procedure
DROP PROCEDURE IF EXISTS update_salary;</pre>
                        </div>
                    </div>
                </div>
                <div id="functions" class="tab-content">
                    <div class="code-container">
                        <div class="code-header"><span class="code-language">SQL</span><button class="copy-btn">Copy</button></div>
                        <div class="code-block">
<pre>-- PostgreSQL Function
CREATE OR REPLACE FUNCTION calculate_bonus(salary DECIMAL, performance INT)
RETURNS DECIMAL
LANGUAGE plpgsql
AS $$
BEGIN
    RETURN salary * (performance / 100.0);
END;
$$;

-- Use function
SELECT first_name, salary, calculate_bonus(salary, 15) AS bonus FROM employees;

-- Table-returning function
CREATE OR REPLACE FUNCTION get_high_earners(min_salary DECIMAL)
RETURNS TABLE(name TEXT, salary DECIMAL)
LANGUAGE plpgsql
AS $$
BEGIN
    RETURN QUERY
    SELECT first_name || ' ' || last_name, e.salary
    FROM employees e
    WHERE e.salary > min_salary;
END;
$$;

-- Use table function
SELECT * FROM get_high_earners(50000);

-- MySQL Function
DELIMITER //
CREATE FUNCTION get_full_name(first_name VARCHAR(50), last_name VARCHAR(50))
RETURNS VARCHAR(100)
DETERMINISTIC
BEGIN
    RETURN CONCAT(first_name, ' ', last_name);
END //
DELIMITER ;

-- SQL Server Function
CREATE FUNCTION dbo.GetAnnualSalary(@monthly_salary DECIMAL)
RETURNS DECIMAL
AS
BEGIN
    RETURN @monthly_salary * 12;
END;</pre>
                        </div>
                    </div>
                </div>
                <div id="control" class="tab-content">
                    <div class="code-container">
                        <div class="code-header"><span class="code-language">SQL</span><button class="copy-btn">Copy</button></div>
                        <div class="code-block">
<pre>-- Variables and control flow (PostgreSQL)
CREATE OR REPLACE FUNCTION process_employees()
RETURNS VOID
LANGUAGE plpgsql
AS $$
DECLARE
    emp_record RECORD;
    total_processed INT := 0;
BEGIN
    -- Loop through employees
    FOR emp_record IN SELECT * FROM employees LOOP
        -- IF statement
        IF emp_record.salary > 100000 THEN
            UPDATE employees SET bonus = salary * 0.2 
            WHERE employee_id = emp_record.employee_id;
        ELSIF emp_record.salary > 50000 THEN
            UPDATE employees SET bonus = salary * 0.1 
            WHERE employee_id = emp_record.employee_id;
        ELSE
            UPDATE employees SET bonus = salary * 0.05 
            WHERE employee_id = emp_record.employee_id;
        END IF;
        
        total_processed := total_processed + 1;
    END LOOP;
    
    RAISE NOTICE 'Processed % employees', total_processed;
END;
$$;

-- Exception handling
BEGIN
    -- risky operation
EXCEPTION
    WHEN division_by_zero THEN
        RAISE NOTICE 'Division by zero error';
    WHEN OTHERS THEN
        RAISE NOTICE 'An error occurred: %', SQLERRM;
END;</pre>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>
    <script src="../../assets/js/main.js"></script>
    <script src="../../assets/js/visualization.js"></script>
    <script>
        let viz;
        document.addEventListener('DOMContentLoaded', function() {
            viz = new DataVisualization('visualization', { cameraPosition: { x: 5, y: 3, z: 5 } });
            showProcedure();
        });
        function showProcedure() {
            viz.clear();
            viz.createDataNode({ type: 'cube', size: 0.5, color: 0x4dabf7, position: { x: -1.5, y: 0.5, z: 0 } });
            viz.createLabel('Input', { x: -1.5, y: 1.3, z: 0 });
            viz.createArrow({ x: -0.9, y: 0.5, z: 0 }, { x: -0.3, y: 0.5, z: 0 }, { color: 0x888888 });
            viz.createDataNode({ type: 'cylinder', size: 0.6, color: 0xe25a1c, position: { x: 0, y: 0.5, z: 0 } });
            viz.createLabel('Procedure', { x: 0, y: 1.4, z: 0 });
            viz.createArrow({ x: 0.4, y: 0.5, z: 0 }, { x: 1, y: 0.5, z: 0 }, { color: 0x888888 });
            viz.createDataNode({ type: 'cube', size: 0.5, color: 0x198754, position: { x: 1.5, y: 0.5, z: 0 } });
            viz.createLabel('Action', { x: 1.5, y: 1.3, z: 0 });
            viz.createLabel('Stored Procedure - Reusable SQL code', { x: 0, y: -1.5, z: 0 });
            viz.createGrid(10, 10);
        }
        function showFunction() {
            viz.clear();
            viz.createDataNode({ type: 'cube', size: 0.5, color: 0x4dabf7, position: { x: -1.5, y: 0.5, z: 0 } });
            viz.createLabel('Input', { x: -1.5, y: 1.3, z: 0 });
            viz.createArrow({ x: -0.9, y: 0.5, z: 0 }, { x: -0.3, y: 0.5, z: 0 }, { color: 0x888888 });
            viz.createDataNode({ type: 'sphere', size: 0.5, color: 0xe25a1c, position: { x: 0, y: 0.5, z: 0 } });
            viz.createLabel('Function', { x: 0, y: 1.3, z: 0 });
            viz.createArrow({ x: 0.4, y: 0.5, z: 0 }, { x: 1, y: 0.5, z: 0 }, { color: 0x888888 });
            viz.createDataNode({ type: 'cube', size: 0.5, color: 0x198754, position: { x: 1.5, y: 0.5, z: 0 } });
            viz.createLabel('Return', { x: 1.5, y: 1.3, z: 0 });
            viz.createLabel('Function - Returns a value', { x: 0, y: -1.5, z: 0 });
            viz.createGrid(10, 10);
        }
    </script>
</body>
</html>
