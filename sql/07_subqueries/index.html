<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Subqueries - SQL Learning Hub</title>
    <link rel="stylesheet" href="../../assets/css/main.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
</head>
<body>
    <header class="header">
        <div class="container header-content">
            <a href="../../index.html" class="logo"><span>Data Engineering Hub</span></a>
            <nav class="nav"><a href="../../index.html#sql" class="nav-link active">SQL</a><button class="theme-toggle">ðŸŒ™</button></nav>
        </div>
    </header>
    <main class="container">
        <section class="section">
            <h1>Subqueries</h1>
            <p>Subqueries are queries nested inside another query. Learn subqueries using standard SQL, PySpark DataFrame API, and PySpark SQL.</p>
            <div id="visualization" class="visualization-container"></div>
            <div class="visualization-controls">
                <button class="viz-btn" onclick="showSubquery()">Subquery</button>
                <button class="viz-btn" onclick="showCorrelated()">Correlated</button>
            </div>
            <h2>Code Examples</h2>
            <div class="tabs">
                <button class="tab active" data-tab="sql">Standard SQL</button>
                <button class="tab" data-tab="pyspark-df">PySpark DataFrame</button>
                <button class="tab" data-tab="pyspark-sql">PySpark SQL</button>
                <button class="tab" data-tab="comparison">Side-by-Side</button>
            </div>
            <div class="tab-contents">
                <div id="sql" class="tab-content active">
                    <div class="code-container">
                        <div class="code-header"><span class="code-language">SQL</span><button class="copy-btn">Copy</button></div>
                        <div class="code-block">
<pre>-- Scalar subquery in WHERE
SELECT * FROM employees
WHERE salary > (SELECT AVG(salary) FROM employees);

-- Subquery with IN
SELECT * FROM employees
WHERE department_id IN (
    SELECT department_id FROM departments WHERE location_id = 1700
);

-- Subquery in FROM (derived table)
SELECT dept_avg.department_id, dept_avg.avg_salary
FROM (
    SELECT department_id, AVG(salary) AS avg_salary
    FROM employees GROUP BY department_id
) AS dept_avg WHERE dept_avg.avg_salary > 50000;

-- Subquery with EXISTS
SELECT * FROM departments d
WHERE EXISTS (SELECT 1 FROM employees e WHERE e.department_id = d.department_id);

-- Correlated subquery
SELECT e.first_name, e.salary FROM employees e
WHERE e.salary > (SELECT AVG(salary) FROM employees WHERE department_id = e.department_id);</pre>
                        </div>
                    </div>
                </div>
                <div id="pyspark-df" class="tab-content">
                    <div class="code-container">
                        <div class="code-header"><span class="code-language">Python (PySpark DataFrame API)</span><button class="copy-btn">Copy</button></div>
                        <div class="code-block">
<pre>from pyspark.sql import SparkSession
from pyspark.sql.functions import col, avg, broadcast

spark = SparkSession.builder.appName("Subqueries").getOrCreate()

# Create sample DataFrames
employees = spark.createDataFrame([
    (1, "Alice", 50000, 10), (2, "Bob", 60000, 20),
    (3, "Charlie", 75000, 10), (4, "Diana", 55000, 30)
], ["id", "name", "salary", "dept_id"])

departments = spark.createDataFrame([
    (10, "Engineering", 1700), (20, "Sales", 1800), (30, "HR", 1700)
], ["dept_id", "dept_name", "location_id"])

# Scalar subquery equivalent - filter by average
avg_salary = employees.agg(avg("salary")).collect()[0][0]
employees.filter(col("salary") > avg_salary).show()

# Subquery with IN equivalent - using join
dept_ids = departments.filter(col("location_id") == 1700).select("dept_id")
employees.join(broadcast(dept_ids), "dept_id", "inner").show()

# Alternative using isin with collected values
dept_list = [row.dept_id for row in dept_ids.collect()]
employees.filter(col("dept_id").isin(dept_list)).show()

# Subquery in FROM equivalent - derived table
dept_avg = employees.groupBy("dept_id").agg(avg("salary").alias("avg_salary"))
dept_avg.filter(col("avg_salary") > 50000).show()

# EXISTS equivalent - using left semi join
employees.join(departments, "dept_id", "left_semi").show()

# NOT EXISTS equivalent - using left anti join
employees.join(departments, "dept_id", "left_anti").show()

# Correlated subquery equivalent - compare to group average
dept_avgs = employees.groupBy("dept_id").agg(avg("salary").alias("dept_avg"))
employees.join(dept_avgs, "dept_id") \
    .filter(col("salary") > col("dept_avg")) \
    .select("name", "salary", "dept_id").show()</pre>
                        </div>
                    </div>
                </div>
                <div id="pyspark-sql" class="tab-content">
                    <div class="code-container">
                        <div class="code-header"><span class="code-language">Python (PySpark SQL)</span><button class="copy-btn">Copy</button></div>
                        <div class="code-block">
<pre>from pyspark.sql import SparkSession

spark = SparkSession.builder.appName("Subqueries").getOrCreate()

# Create and register temp views
employees = spark.createDataFrame([
    (1, "Alice", 50000, 10), (2, "Bob", 60000, 20),
    (3, "Charlie", 75000, 10), (4, "Diana", 55000, 30)
], ["id", "name", "salary", "dept_id"])
employees.createOrReplaceTempView("employees")

departments = spark.createDataFrame([
    (10, "Engineering", 1700), (20, "Sales", 1800), (30, "HR", 1700)
], ["dept_id", "dept_name", "location_id"])
departments.createOrReplaceTempView("departments")

# Scalar subquery in WHERE
spark.sql("""
    SELECT * FROM employees
    WHERE salary > (SELECT AVG(salary) FROM employees)
""").show()

# Subquery with IN
spark.sql("""
    SELECT * FROM employees
    WHERE dept_id IN (SELECT dept_id FROM departments WHERE location_id = 1700)
""").show()

# Subquery in FROM (derived table)
spark.sql("""
    SELECT dept_avg.dept_id, dept_avg.avg_salary
    FROM (
        SELECT dept_id, AVG(salary) AS avg_salary
        FROM employees GROUP BY dept_id
    ) AS dept_avg
    WHERE dept_avg.avg_salary > 50000
""").show()

# Subquery with EXISTS
spark.sql("""
    SELECT * FROM departments d
    WHERE EXISTS (SELECT 1 FROM employees e WHERE e.dept_id = d.dept_id)
""").show()

# Correlated subquery
spark.sql("""
    SELECT e.name, e.salary, e.dept_id FROM employees e
    WHERE e.salary > (SELECT AVG(salary) FROM employees WHERE dept_id = e.dept_id)
""").show()</pre>
                        </div>
                    </div>
                </div>
                <div id="comparison" class="tab-content">
                    <div class="code-container">
                        <div class="code-header"><span class="code-language">Side-by-Side Comparison</span><button class="copy-btn">Copy</button></div>
                        <div class="code-block">
<pre># ============================================
# SUBQUERIES: DataFrame API vs SQL
# ============================================
from pyspark.sql import SparkSession
from pyspark.sql.functions import col, avg

spark = SparkSession.builder.appName("Comparison").getOrCreate()

data = [(1, "Alice", 50000, 10), (2, "Bob", 60000, 10), (3, "Charlie", 45000, 20)]
df = spark.createDataFrame(data, ["id", "name", "salary", "dept_id"])
df.createOrReplaceTempView("employees")

# SCALAR SUBQUERY (filter by average)
# DataFrame API:
avg_sal = df.agg(avg("salary")).collect()[0][0]
df.filter(col("salary") > avg_sal).show()
# PySpark SQL:
spark.sql("SELECT * FROM employees WHERE salary > (SELECT AVG(salary) FROM employees)").show()

# DERIVED TABLE (subquery in FROM)
# DataFrame API:
dept_avg = df.groupBy("dept_id").agg(avg("salary").alias("avg_sal"))
dept_avg.filter(col("avg_sal") > 50000).show()
# PySpark SQL:
spark.sql("""
    SELECT * FROM (SELECT dept_id, AVG(salary) AS avg_sal FROM employees GROUP BY dept_id) t
    WHERE avg_sal > 50000
""").show()

# CORRELATED SUBQUERY
# DataFrame API:
dept_avgs = df.groupBy("dept_id").agg(avg("salary").alias("dept_avg"))
df.join(dept_avgs, "dept_id").filter(col("salary") > col("dept_avg")).show()
# PySpark SQL:
spark.sql("""
    SELECT * FROM employees e
    WHERE salary > (SELECT AVG(salary) FROM employees WHERE dept_id = e.dept_id)
""").show()</pre>
                        </div>
                    </div>
                </div>
            </div>
            <div style="display: flex; justify-content: space-between; margin-top: 3rem; padding-top: 2rem; border-top: 1px solid var(--border-color);">
                <a href="../06_order_by/index.html" style="color: var(--text-muted);">&larr; Previous: ORDER BY</a>
                <a href="../08_ctes/index.html" style="color: var(--accent-primary);">Next: CTEs &rarr;</a>
            </div>
        </section>
    </main>
    <script src="../../assets/js/main.js"></script>
    <script src="../../assets/js/visualization.js"></script>
    <script>
        let viz;
        document.addEventListener('DOMContentLoaded', function() {
            viz = new DataVisualization('visualization', { cameraPosition: { x: 5, y: 3, z: 5 } });
            showSubquery();
        });
        function showSubquery() {
            viz.clear();
            viz.createDataNode({ type: 'cube', size: 1, color: 0x4dabf7, position: { x: 0, y: 0.5, z: 0 } });
            viz.createDataNode({ type: 'cube', size: 0.5, color: 0xe25a1c, position: { x: 0, y: 0.5, z: 0 } });
            viz.createLabel('Outer Query', { x: 0, y: 1.8, z: 0 });
            viz.createLabel('Inner Query', { x: 0, y: 0.5, z: 1 });
            viz.createLabel('Subquery - Query inside query', { x: 0, y: -1.5, z: 0 });
            viz.createGrid(10, 10);
        }
        function showCorrelated() {
            viz.clear();
            viz.createDataNode({ type: 'cube', size: 0.8, color: 0x4dabf7, position: { x: -1, y: 0.5, z: 0 } });
            viz.createDataNode({ type: 'cube', size: 0.5, color: 0xe25a1c, position: { x: 1, y: 0.5, z: 0 } });
            viz.createArrow({ x: -0.4, y: 0.5, z: 0 }, { x: 0.4, y: 0.5, z: 0 }, { color: 0x888888 });
            viz.createArrow({ x: 0.4, y: 0.3, z: 0 }, { x: -0.4, y: 0.3, z: 0 }, { color: 0x888888 });
            viz.createLabel('Correlated - References outer query', { x: 0, y: -1.5, z: 0 });
            viz.createGrid(10, 10);
        }
    </script>
</body>
</html>
