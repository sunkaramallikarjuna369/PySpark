<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Window Functions - SQL Learning Hub</title>
    <link rel="stylesheet" href="../../assets/css/main.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
</head>
<body>
    <header class="header">
        <div class="container header-content">
            <a href="../../index.html" class="logo"><span>Data Engineering Hub</span></a>
            <nav class="nav"><a href="../../index.html#sql" class="nav-link active">SQL</a><button class="theme-toggle">ðŸŒ™</button></nav>
        </div>
    </header>
    <main class="container">
        <section class="section">
            <h1>Window Functions</h1>
            <p>Window functions perform calculations across a set of rows related to the current row, without collapsing the result set like GROUP BY.</p>
            <div id="visualization" class="visualization-container"></div>
            <div class="visualization-controls">
                <button class="viz-btn" onclick="showWindow()">Window</button>
                <button class="viz-btn" onclick="showRanking()">Ranking</button>
            </div>
            <h2>Code Examples</h2>
            <div class="tabs">
                <button class="tab active" data-tab="ranking">Ranking Functions</button>
                <button class="tab" data-tab="aggregate">Aggregate Windows</button>
                <button class="tab" data-tab="offset">Offset Functions</button>
            </div>
            <div class="tab-contents">
                <div id="ranking" class="tab-content active">
                    <div class="code-container">
                        <div class="code-header"><span class="code-language">SQL</span><button class="copy-btn">Copy</button></div>
                        <div class="code-block">
<pre>-- ROW_NUMBER - unique sequential number
SELECT 
    first_name, salary, department_id,
    ROW_NUMBER() OVER (ORDER BY salary DESC) AS row_num
FROM employees;

-- ROW_NUMBER with PARTITION
SELECT 
    first_name, salary, department_id,
    ROW_NUMBER() OVER (
        PARTITION BY department_id 
        ORDER BY salary DESC
    ) AS dept_rank
FROM employees;

-- RANK - same rank for ties, gaps after
SELECT 
    first_name, salary,
    RANK() OVER (ORDER BY salary DESC) AS rank
FROM employees;

-- DENSE_RANK - same rank for ties, no gaps
SELECT 
    first_name, salary,
    DENSE_RANK() OVER (ORDER BY salary DESC) AS dense_rank
FROM employees;

-- NTILE - divide into N buckets
SELECT 
    first_name, salary,
    NTILE(4) OVER (ORDER BY salary DESC) AS quartile
FROM employees;

-- PERCENT_RANK and CUME_DIST
SELECT 
    first_name, salary,
    PERCENT_RANK() OVER (ORDER BY salary) AS pct_rank,
    CUME_DIST() OVER (ORDER BY salary) AS cum_dist
FROM employees;</pre>
                        </div>
                    </div>
                </div>
                <div id="aggregate" class="tab-content">
                    <div class="code-container">
                        <div class="code-header"><span class="code-language">SQL</span><button class="copy-btn">Copy</button></div>
                        <div class="code-block">
<pre>-- Running total
SELECT 
    first_name, salary,
    SUM(salary) OVER (ORDER BY hire_date) AS running_total
FROM employees;

-- Running average
SELECT 
    first_name, salary,
    AVG(salary) OVER (ORDER BY hire_date) AS running_avg
FROM employees;

-- Partition aggregates
SELECT 
    first_name, salary, department_id,
    SUM(salary) OVER (PARTITION BY department_id) AS dept_total,
    AVG(salary) OVER (PARTITION BY department_id) AS dept_avg
FROM employees;

-- Window frame specification
SELECT 
    first_name, salary,
    AVG(salary) OVER (
        ORDER BY hire_date
        ROWS BETWEEN 2 PRECEDING AND CURRENT ROW
    ) AS moving_avg_3
FROM employees;

-- ROWS vs RANGE
SELECT 
    first_name, salary,
    SUM(salary) OVER (ORDER BY salary ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS rows_sum,
    SUM(salary) OVER (ORDER BY salary RANGE BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS range_sum
FROM employees;</pre>
                        </div>
                    </div>
                </div>
                <div id="offset" class="tab-content">
                    <div class="code-container">
                        <div class="code-header"><span class="code-language">SQL</span><button class="copy-btn">Copy</button></div>
                        <div class="code-block">
<pre>-- LAG - access previous row
SELECT 
    first_name, salary, hire_date,
    LAG(salary) OVER (ORDER BY hire_date) AS prev_salary,
    salary - LAG(salary) OVER (ORDER BY hire_date) AS salary_change
FROM employees;

-- LAG with offset and default
SELECT 
    first_name, salary,
    LAG(salary, 2, 0) OVER (ORDER BY hire_date) AS salary_2_ago
FROM employees;

-- LEAD - access next row
SELECT 
    first_name, salary,
    LEAD(salary) OVER (ORDER BY hire_date) AS next_salary
FROM employees;

-- FIRST_VALUE and LAST_VALUE
SELECT 
    first_name, salary, department_id,
    FIRST_VALUE(salary) OVER (
        PARTITION BY department_id ORDER BY salary DESC
    ) AS highest_in_dept,
    LAST_VALUE(salary) OVER (
        PARTITION BY department_id ORDER BY salary DESC
        ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
    ) AS lowest_in_dept
FROM employees;

-- NTH_VALUE
SELECT 
    first_name, salary,
    NTH_VALUE(salary, 2) OVER (ORDER BY salary DESC) AS second_highest
FROM employees;</pre>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>
    <script src="../../assets/js/main.js"></script>
    <script src="../../assets/js/visualization.js"></script>
    <script>
        let viz;
        document.addEventListener('DOMContentLoaded', function() {
            viz = new DataVisualization('visualization', { cameraPosition: { x: 5, y: 3, z: 5 } });
            showWindow();
        });
        function showWindow() {
            viz.clear();
            for (let i = 0; i < 5; i++) {
                const inWindow = i >= 1 && i <= 3;
                viz.createDataNode({ type: 'cube', size: 0.4, color: inWindow ? 0xe25a1c : 0x4dabf7, position: { x: 0, y: 2 - i * 0.7, z: 0 } });
            }
            viz.createLabel('Window Frame', { x: 1.5, y: 0.5, z: 0 });
            viz.createLabel('Window - Sliding frame over rows', { x: 0, y: -2, z: 0 });
            viz.createGrid(10, 10);
        }
        function showRanking() {
            viz.clear();
            const ranks = [1, 2, 2, 4, 5];
            for (let i = 0; i < 5; i++) {
                viz.createDataNode({ type: 'cube', size: 0.4, color: 0x4dabf7, position: { x: 0, y: 2 - i * 0.7, z: 0 } });
                viz.createLabel(String(ranks[i]), { x: 0.8, y: 2 - i * 0.7, z: 0 });
            }
            viz.createLabel('RANK() - Ranking with ties', { x: 0, y: -2, z: 0 });
            viz.createGrid(10, 10);
        }
    </script>
</body>
</html>
